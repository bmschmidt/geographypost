<!DOCTYPE html>
<head>
<meta charset="utf-8">

<link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,300' rel='stylesheet' type='text/css'>

<link href="style.css" rel="stylesheet" type="text/css">
<title>Geography of the Post</title>

</head>

<body>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>

<div id="info">
    <h1>The Geography of the Nineteenth-Century Post</h1>
  <div id="about">
    <ul>
        <li>Cameron Blevins</li>
        <li><span class="sc">Stanford University</span></li>
    </ul>
  </div>
</div>

<script>

//********************************************
// Global variables
//********************************************

var width = 960,
    height = 750,
    barchart_margin = {top: 20, right: 20, bottom: 30, left: 40},
    barchart_width = 960 - barchart_margin.left - barchart_margin.right,
    barchart_height = 200 - barchart_margin.top - barchart_margin.bottom;

// Scales
var x = d3.scale.ordinal().rangeRoundBands([0, barchart_width], .1); // trying the barchart_width. Change back to 'width' if it messes up stuff
var y = d3.scale.linear().range([barchart_height, 0]);

// Get our data ready
queue()
    .defer(d3.json, "/data/us.json")
    .defer(d3.csv, "/data/blevins.csv")
    .await(ready);

// Colors
var aliveThroughout = "#2CB5AC", //Teal
  diesDuring = "#B52C35", //Red
  bornDuring = "#FFFF99", //Yellow
  aliveDuring = "#0A0"; //Green

//********************************************
// Map
//********************************************

   // azimuth projection
var projection = d3.geo.azimuthalEqualArea()
    .translate([680, 380])
    .rotate([118.9, 0])
    .center([0, 42.5])
    .scale(1200 * 5);

    // satellite projection
    // use this one instead?
var projection2 = d3.geo.satellite()
    .distance(1.1)
    .scale(5500)
    .rotate([118.00, -34.50, 32.12])
    .center([-2, 5])
    .tilt(25)
    .clipAngle(Math.acos(1 / 1.1) * 180 / Math.PI - 1e-6)
    .precision(.1); 

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", "460");               // change this back to `height`

var graticule = d3.geo.graticule()
    .extent([[-98 - 45, 38 - 45], [-98 + 45, 38 + 45]])
    .step([22.5 / 4, 22.5 / 4]);

this.path = d3.geo.path()
    .projection(projection);

// Printing the map

svg.append("path")
    .datum(graticule.outline)
    .attr("class", "background")
    .attr("d", this.path);

function ready(error, us, post) {
  this.defs = this.svg.append("defs");

  svg.append("path")
      .datum(topojson.object(us, us.objects.land))
      .attr("class", "land")
      .attr("d", this.path);

  this.land = this.svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a.id !== b.id; }))
      .attr("class", "boundary")
      .attr("d", this.path);

  this.svg.append("clipPath")
    .attr("id", "clip")
    .append("use")
    .attr("xlink:href", "#land");

  // Printing all points
  this.postoffices = svg.selectAll("g.points-est")
      .data(post)
    .enter().append("g")
     .attr("class","points-est")
     .style("fill", "red")
     .attr("transform", function(d) {return "translate(" + projection([d["Longitude"], d["Latitude"]]) + ")"; })
     .on("mouseover", showLabel)
     .on("mouseout", function() {d3.selectAll("text.map-tooltip").remove(); });
  // TODO(jheppler): For future use -- a function to take the salaries of the post offices and resize
  // the points based on their amount.
  // .attr("r", function(d) {
  //   return Math.sqrt(parseInt(d["salaries"]) * 0.00004);
  // })

  this.postoffices
    .append("circle")
      .attr("r", 3)
      .attr("class","points-est")
      .style("fill", aliveDuring);

  // *******************************************
  // Printing the entire CSV file as a table
  // *******************************************

  // TODO(jheppler): Modify this so it auto-updates as a brush event is created.
  var columns = ["Name", "Est", "Dis1", "Re1", "Dis2", "Re2", "Dis3", "Re3", "Dis4", "Re4", "Latitude", "Longitude"];

    // Print the table by placing a `div` with `id` of `container` below
    var table = d3.select("#container").append("table"),
        thead = table.append("thead"),
        tbody = table.append("tbody");

    thead.append("tr")
    .selectAll("th")
      .data(columns)
    .enter()
      .append("th")
      .text(function(column) { return column; });

    var rows = tbody.selectAll("tr")
      .data(post)
    .enter()
      .append("tr");

    var cells = rows.selectAll("td")
      .data(function(row) {
          return columns.map(function(column) {
              return {column: column, value: row[column]};
          });
      })
    .enter()
      .append("td")
      .text(function(d) { return d.value; });

// *********************************************
// Callbacks
// *********************************************

  // On hover, show point labels
  function showLabel(d,i) {
    d3.select(this).append("text").attr("class", "map-tooltip").text(d["Name"]);
    this.parentNode.appendChild(this);
  }

}

//********************************************
// Graphing the year counts as a bar chart
//********************************************

// Prepare the canvas
var barchart = d3.select("body").append("svg")
    .attr("width", barchart_width + barchart_margin.left + barchart_margin.right)
    .attr("height", barchart_height + barchart_margin.top + barchart_margin.bottom)
  .append("g")
    .attr("transform", "translate(" + barchart_margin.left + "," + barchart_margin.top + ")");

d3.csv("/data/years_count.csv", function(error, post) {

  brush = d3.svg.brush()
    .x(x)
    .on("brush", brushed)
    .on("brushstart", brushed)
    .on("brushend", brushed);

  // Coercion since CSV is untyped
  post.forEach(function(d) {
    d["frequency"] = +d["frequency"];
    d["year"] = d3.time.format("%Y").parse(d["year"]).getFullYear();
  });

  x.domain(post.map(function(d) { return d["year"]; }));
  y.domain([0, d3.max(post, function(d) { return d["frequency"]; })]);

  // Axis variables for the bar chart
  x_axis = d3.svg.axis().scale(x).tickValues([1850,1855,1860,1865,1870,1875,1880,1885,1890,1895,1900]).orient("bottom");
  y_axis = d3.svg.axis().scale(y).orient("left");

  // x axis
  barchart.append("g")
      .attr("class", "x axis")
      .call(x_axis)
      .attr("transform", "translate(0," + barchart_height + ")");

  // y axis
  barchart.append("g")
      .attr("class", "y axis")
      .call(y_axis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("No. of established");

  // Draw the bars
  barchart.selectAll(".bar")
      .data(post)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.frequency); })
      .attr("id", function(d) { return "year-" + d.year; })
      .attr("height", function(d) { return barchart_height - y(d.frequency); });

  // Draw the brush
  barchart.append("g")
      .attr("class", "brush")
      .call(brush)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", barchart_height + 7)
      .append("title")
      .text("Drag left or right to brush along this axis.");

  // ****************************************
  // Callbacks
  // ****************************************
  
  function brushed() {
    b = brush.empty() ? [0,9999] : brush.extent();
    // console.log(x.domain());
    newscale = d3.scale.linear();
    newscale.domain(x.range()).range(x.domain());
    var year_begin = newscale(b[0]);
    var year_end = newscale(b[1]);
    

    var arrSize = 4;

    //Returns whether or not the post office was alive at a given date
    function isAliveStart(estArr, lifeSpanArr, brushDate) {
      for (var i = 0; i < arrSize; i++) {
        if (estArr[i] < brushDate && brushDate <= (estArr[i] + lifeSpanArr[i])) {
          return true;
        }
      }
      return false;
    }

    function isAliveEnd(estArr, lifeSpanArr, brushDate) {
      for (var j = 0; j < arrSize; j++) {
        if (estArr[j] <= brushDate && brushDate <= (estArr[j] + lifeSpanArr[j])) {
          return true;
        }
      }
      return false;
    }



    //If the post office was established during the brush, it existed during the brush.
    //Only post offices that were dead at the start and end of the brush are passed to this function.
    function isDuring(est, brushMin, brushMax) {
      for (var k = 0; k < arrSize; k++) {
        if (brushMin <= est[k] && est[k] <= brushMax) {
          return true;
        }
      }   
      return false;
    }



    //To make math work, set a disestablish date of greater than the maximum date in the span of years if a post office is never disestablished.
    var defaultDis = 1905;  // TODO(jheppler): Convert this to d3.max function to automatically
                            // find the max year date + 1


    d3.selectAll("g.points-est").style("display", function(d, i) { 
 
    
      // Convert dates into integers
      // If a post office is not disestablished, set its disestablish date to default, greater than any possible year in the brush. (Sorry this is so sloppy.)
      var dEst = parseInt(d.Est.split("-")[0]);
      var dRe1 = parseInt(d.Re1.split("-")[0]);
      var dRe2 = parseInt(d.Re2.split("-")[0]);
      var dRe3 = parseInt(d.Re3.split("-")[0]);

      var dDis1 = parseInt(d.Dis1.split("-")[0]);
      if (d.Dis1 == "") {
        dDis1 = defaultDis;
      }

      var dDis2 = parseInt(d.Dis2.split("-")[0]);
      if(d.Dis2 == "") {
        dDis2 = defaultDis;
      }

      var dDis3 = parseInt(d.Dis3.split("-")[0]);
      if (d.dis3 == "") {
        dDis3 = defaultDis;
      }

      var dDis4 = parseInt(d.Dis4.split("-")[0]);
      if (d.Dis4 == "") {
        dDis4 = defaultDis;
      }


       // Arrays of established dates and subsequent life spans of a single post office. 
      // Note: assumes there are exactly 4 establish dates in the data
      var estArr = [dEst, dRe1, dRe2, dRe3];
      var lifespanArr = [dDis1 - dEst, dDis2 - dRe1, dDis3 - dRe2, dDis4 - dRe3];


      // Bools are true if post office was alive at the time of brushMin and brushMax
      var startAlive = false;
      var endAlive = false;
         

      // Determine whether or not a post is alive at the start and end of brush
      startAlive = isAliveStart(estArr, lifespanArr, year_begin);
      endAlive = isAliveEnd(estArr, lifespanArr, year_end);


      if (startAlive && endAlive) { 
        return "block"; 
      } else if (startAlive && !endAlive) { 
        return "block"; 
      } else if (!startAlive && endAlive) { 
        return "block"; 
      } else if (isDuring(estArr, year_begin, year_end)) { 
        return "block"; 
      }
      return "none";
    });



    //Colors the points to reflect their category within the brush
    d3.selectAll("circle.points-est").style("fill", function(d, i) { 
  
  
      // Convert dates into integers
      // If a post office is not disestablished, set its disestablish date to default, greater than any possible year in the brush. (Sorry this is so sloppy.)
      var dEst = parseInt(d.Est.split("-")[0]);
      var dRe1 = parseInt(d.Re1.split("-")[0]);
      var dRe2 = parseInt(d.Re2.split("-")[0]);
      var dRe3 = parseInt(d.Re3.split("-")[0]);

      var dDis1 = parseInt(d.Dis1.split("-")[0]);
      if (d.Dis1 == "") {
        dDis1 = defaultDis;
      }

      var dDis2 = parseInt(d.Dis2.split("-")[0]);
      if(d.Dis2 == "") {
        dDis2 = defaultDis;
      }

      var dDis3 = parseInt(d.Dis3.split("-")[0]);
      if (d.dis3 == "") {
        dDis3 = defaultDis;
      }

      var dDis4 = parseInt(d.Dis4.split("-")[0]);
      if (d.Dis4 == "") {
        dDis4 = defaultDis;
      }


       // Arrays of established dates and subsequent life spans of a single post office. 
      // Note: assumes there are exactly 4 establish dates in the data
      var estArr = [dEst, dRe1, dRe2, dRe3];
      var lifespanArr = [dDis1 - dEst, dDis2 - dRe1, dDis3 - dRe2, dDis4 - dRe3];


      // Bools are true if post office was alive at the time of brushMin and brushMax
      var startAlive = false;
      var endAlive = false;
         

      // Determine whether or not a post is alive at the start and end of brush
      startAlive = isAliveStart(estArr, lifespanArr, year_begin);
      endAlive = isAliveEnd(estArr, lifespanArr, year_end);


      if (startAlive && endAlive) { //Alive throughout (or at least at start and end)
        return aliveThroughout; //Teal
      } else if (startAlive && !endAlive) { //Dies during brush
        return diesDuring; //Red
      } else if (!startAlive && endAlive) { //Established during brush
        return bornDuring; //Yellow
      } else if (isDuring(estArr, year_begin, year_end)) { //Est. and dies during brush.
        return aliveDuring; //Green
      } else {
        return "black";
      }

    });


 d3.selectAll("rect.bar").style("opacity", function(d, i) { return d.year >= year_begin && d.year <= year_end ? "1" : ".5" });
  

  }

});

</script>

<!-- TODO(jheppler): For the future: be able to click on a time-framed event and create the brush event for a given period of time. -->
<div id="nav">
    <ul>
        <li><a href="#">Single Year</a></li>
        <li><a href="#">Civil War</a></li>
        <li><a href="#">Western Expansion</a></li>
        <li><a href="#">Gilded Age</a></li>
    </ul>
</div>

<p>The visualizations above (built with <a href="http://d3js.org">D3</a>) plot the opening, closing, and in some cases the re-opening and re-closing, of nearly 1,500 post offices in Oregon between 1847 and 1902. Click and drag on the bar chart to filter the post offices. The colored points indicate whether a post office was opened, existed, or closed during that time period. The table below provides details on demand.</p>

<p>The <span id="legend" style="color: #2CB5AC;">Teal</span> points reference Post Offices that are alive throughout a brush extent, the <span id="legend" style="color: #B52C35;">Red</span> points indicate Post Offices that are closed within the extent of a brush, the <span id="legend" style="color: #FFFF99;">Yellow</span> color indicates Post Offices that are established sometime during the brush extent, and the <span id="legend" style="color: #0A0;">Green</span> points indicate a Post Office that is established during the brush. Hover over points on the map to view more information about individual post offices.</p>

<div id="selections">
  <h4>Offices</h4>
  <form>
    <input type="checkbox" name="maps" value="All">All<br>
    <input type="checkbox" name="maps" value="Established">Established<br>
    <input type="checkbox" name="maps" value="Discontinued">Discontinued
  </form>
</div>

<div id="container"></div>

<footer>
  <span style="float:right;">
    Released under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.
  </span>
<<<<<<< Updated upstream
  Visualized by <a href="http://www.jasonheppler.org">Jason Heppler</a>, Jocelyn Hickcox, Tara Balakrishnan. Special thanks to Elijah Meeks.
=======
  Visualized by <a href="http://www.jasonheppler.org">Jason Heppler</a>, Tara Balakrishnan, and Jocelyn Hickcox. Special thanks to Elijah Meeks.
>>>>>>> Stashed changes
</footer>
