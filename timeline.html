<!DOCTYPE html>
<meta charset="utf-8">
<style>

.mesh {
  fill: none;
  stroke: #333;
  stroke-width: .5px;
  stroke-linejoin: round;
}

.play circle {
  fill: white;
  stroke: black;
  stroke-width: 3px;
}

.play:hover path {
  fill: red;
}

.play.mousedown circle {
  fill: red;
}

.play.mousedown path {
  fill: white;
}

.play rect {
  fill: none;
  pointer-events: all;
  cursor: pointer;
}

.ring {
  fill: none;
  stroke: red;
  stroke-width: 3px;
  stroke-linejoin: round;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script>

var width = 960,
    height = 600;

// Get our data ready
queue()
    .defer(d3.json, "/data/us.json")
    .defer(d3.csv, "/data/post_data.csv")
    .await(ready);

var path = d3.geo.path()
    .projection(null);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var projection = d3.geo.azimuthalEqualArea()
    .translate([680, 380])
    .rotate([118.9, 0])
    .center([10, 36.5])
    .scale(870 * 2);

path = d3.geo.path()
    .projection(projection);

function ready(error, us, post) {
  svg.append("path")
      .datum(topojson.mesh(us))
      .attr("class", "mesh")
      .attr("d", path);

  // Play button
  var play = svg.append("g")
      .attr("class", "play");

  play.append("circle")
      .attr("r", 45)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  play.append("path")
      .attr("d", "M-22,-30l60,30l-60,30z")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(.7)");

  play.append("rect")
      .attr("width", width)
      .attr("height", height)
      .on("mousedown", function() {
        play.classed("mousedown", true);
        d3.select(window).on("mouseup", function() { play.classed("mousedown", false); });
      })
      .on("click", function() {
        resetAll();
        animation();
      });

  function resetAll() {
    play.style("display", null);
  }

  // Animation function -- printing points over time
  function animation() {
    play.style("display", "none");

    var postOfficePoints = svg.selectAll("g.points")
        .data(post)
      .enter().append("g")
       .attr("class","post-label")
       .style("fill", "steelblue")
       .attr("transform", function(d) {return "translate(" + projection([d["Longitude"], d["Latitude"]]) + ")"; })

    var interval = setInterval(function() {
      // var office = postOfficePoints.pop();
      // if (!office) return clearInterval(interval), void setTimeout(resetAll, 750);

      // postOfficePoints
      //   .append("circle")
      //   .attr("r", 2.5)
      //   .attr("class", "points");

    postOfficePoints.append("circle").attr("r", 2.5).attr("class","points");
    postOfficePoints.transition().duration(1000).attr("x", function(d, i) { return (d.value) });

//need?
      // svg.append("path")
      //   .data(post)
      //   .attr("class", "points")
      //   .attr("d", path)
      //   .transition()
      //     .duration(500)
      //     .style("stroke-opacity", 0)
      //     .remove();
    }, 100);
  }
};

</script>